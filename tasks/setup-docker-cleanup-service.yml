---
- name: Create cleanup service
  copy:
    src: ./files/docker-cleanup.service
    dest: "/etc/systemd/system/docker-cleanup.service"
    owner: root
    group: root
    mode: 0644
  register: cleanup_service
  notify: Reload systemd

- name: Create cleanup timer
  template:
    src: docker-cleanup.timer.j2
    dest: "/etc/systemd/system/docker-cleanup.timer"
    owner: root
    group: root
    mode: 0644
  notify: Reload systemd

- name: Setup cleanup service
  systemd:
    name: docker-cleanup.service
    enabled: true

- name: Start cleanup timer
  systemd:
    name: docker-cleanup.timer
    enabled: true
    state: started
  when: cleanup_enabled is defined
    and cleanup_enabled | bool

- name: Stop cleanup timer
  systemd:
    name: docker-cleanup.timer
    enabled: false
    state: stopped
  when: cleanup_enabled is not defined
    or not (cleanup_enabled | bool)
